<html>
<head>

<script src="/queryable.js"></script>
<script src="/vocabulary.js"></script>
<script src="/pager.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.15/angular.min.js"></script>

<meta name="viewport"
  content="width=device-width,
  minimum-scale=1.0, maximum-scale=1.0" />

<link href="/css/style.css" rel="stylesheet">

<style>
* { padding:0; margin:0; }

table tr td { 
    min-width:40px;
    padding:1px 5px;
    border:2px solid #bbb;
}
table tr td b { font-size: 1.2em; font-weight: bold; }
#container { 
padding: 10px; 
margin: 10px auto; 
border:2px solid #125; 
width:70%;
}
#container b {
    font-family: Arial, sans-serif;
    font-weight: bold;
    font-size: 1.2em;
    margin: 0 0 8px 0;
}
#container span {
    font-family: "Trebuchet MS", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", Tahoma, sans-serif;
    font-weight: normal;
    font-size: 1.0em;
}

.popover_box {
    width:540px; /* 270 */
    background-color:#EBDADA;

    box-shadow: 3px 4px 6px #090909;
    border-radius:4px;

    position: absolute;
    left:50%;
    margin-left:-290px; /* w + pad + bord */
    top: 80px;

    padding: 25px 10px;
    border:10px solid #5c9bb7;
}

.confirm {
    background-color: #fff;

    position: absolute;
    left:50%;
    margin-left:-150px; /* w + pad + bord */
    top: 80px;

    width: 300px;
    height: 240px;

    border: 4px solid black;
    font-weight: bold;
}
</style>


<script>
function _alertFunc(msg) {
    alert( "message: '" + msg + "'" );
}

angular.module("vocabApp", [])
  .filter( 'searchFor', function() {
    return function(arr, searchString, count) {
        var result = [];
        if (!searchString) {
            if ( count ) 
                return result.length;
            return result;
        }
        var regex = new RegExp( '^' + searchString.toLowerCase() );

        // Using the forEach helper method to loop through the array
        angular.forEach(arr, function(item){
            if ( item.word.match( regex ) ) {
                result.push(item);
            }
        });
        
        if ( count ) 
            return result.length;
        return result;
    } ;
  } )

  .filter( 'matchCount', function() {
    return function(arr, searchString) {
        if (!searchString) {
            return 0;
        }

        var how_many = 0;

        var regex = new RegExp( '^' + searchString.toLowerCase() );

        // Using the forEach helper method to loop through the array
        angular.forEach(arr, function(item){
            if ( item.word.match( regex ) ) {
                ++how_many;
            }
        });
        
        return how_many;
    } ;
  } )

    .filter( 'arrayLength', function() {
        return function(ary) {
            if ( arguments.length === 0 )
                return 0;
            return ary.length;
        };
    } )

  .filter( 'reverse', function() {
    return function(word) {
        if (!word || word.length == 0) {
            return '';
        }
        var r = [];
        for ( var i = word.length-1 ; i >= 0; i-- ) {
            r.push( word[i] );
        }
        return r.join('').toUpperCase();
    } ;
  } )

    .filter( 'strlen', function() {
        return function(word) {
            if ( !word )
                return 0;
            return word.length;
        };
    } )

    .filter( 'isExactMatch', function() {
        return function(ary,word) {
            if (!word || word.length < 1) {
                return {bval:false,def:''};
            }
            var how_many = 0;
            word = word.toLowerCase();
            var regex = new RegExp( '^' + word + '$' );
            var def = '';
            angular.forEach(ary, function(item){
                if ( item.word.match( regex ) ) {
                    ++how_many;
                    def = item.def;
                }
            });
            return 1 == how_many ? {bval:true,def:def} : {bval:false,def:''};
        };
    } )

  .controller( 'searchBoxController', function($scope, $filter) 
  {
    $scope.items = [];
    $scope.keycount = -777;
    $scope.enterMessage = '';
    $scope.showtooltip = false;
    $scope.showConfirm = false;
    $scope.allowOverride = true;

    $scope.init = function() { 
        $scope.keycount = 0; 
        // create db from JSON from vocabulary.js
        $scope.db = queryable.open( {"db_name":"TestPage","data":JSON.stringify(_stub_vocabulary)} );
        $scope.items = $scope.db.find(/.*/);
        $scope.items = $scope.items._data;

        //$scope.items = _stub_vocabulary;
    }

    $scope.alertFunc = _alertFunc;

    $scope.key = function(e) {
        $scope.keycount++;
        if ( e.which === 13 ) { // RETURN/ENTER
            //$scope.alertFunc( $scope.searchString );

            e.stopPropagation();

            if ( $scope.showConfirm ) {
                $scope.insertOrUpdate();
                $scope.hideTooltip();
                $scope.hideConfirm();
            } else if ( ! $scope.showtooltip ) {
                $scope.showtooltip = true;
            } else {
                $scope.showConfirm = true;
            }
        }
        else if ( e.which === 27 ) { // ESCAPE
            if ( $scope.showConfirm ) {
                $scope.hideConfirm();
            } else {
                $scope.hideTooltip();
                $scope.hideConfirm();
            }
        }
    };

    $scope.hideTooltip = function() {
        $scope.showtooltip = false;
    };
    $scope.hideConfirm = function() {
        $scope.showConfirm = false;
    }

    $scope.insertOrUpdate = function() {
        var regex = new RegExp( '^'+$scope.searchString+'$' );
        var res = $scope.db.find( {word:regex} );
        if ( res.length == 1 ) { // UPDATE
            $scope.db.update( {word:regex}, {'$set':{def:$scope.definition}} );
        } else { // INSERT
            $scope.db.insert( {word:$scope.searchString,def:$scope.definition} );
        }
        
        $scope.items = $scope.db.find(/.*/);
        $scope.items = $scope.items._data;
    };

    $scope.dynamicDefinition = function() {
        var exactDef = $filter('isExactMatch')($scope.items,$scope.searchString);
        // if definition box has focus, don't force-set it, 
        // only change it if editing the 'word' parm

        if ( $scope.allowOverride ) 
            $scope.definition = exactDef.def;
        return exactDef.bval;
    };

    $scope.stopOverride = function() {
        $scope.allowOverride = false;
    };

    $scope.resumeOverride = function() {
        $scope.allowOverride = true;
    };


    //
    $scope.$on( 'toggle', function() {
        $scope.do_msg = !$scope.do_msg;
    } );

    $scope.send_event = function() {
    };

} );
</script>

</head>

<body ng-app="vocabApp" ng-controller="searchBoxController" ng-init="init()" ng-click="hideTooltip()" ng-keydown="key($event)" ng-keyup="send_event()" >

<div id="main-panel">
<center>

  <div id="container">
    <b>Arcane Vocabulary Tutor</b><br>
    <span>Type to Lookup Word:</span><br>
    <div class="bar">
        <!-- binding between the searchString model and the text field -->
        <input type="text" ng-model="searchString" placeholder="Enter your search terms" />
    </div>

    <br>
    <table>
      <tr><td>
          key down count: 
      </td><td>
          <b>{{keycount}}</b>
      </td></tr>
      <tr><td>
          total number words: 
      </td><td>
          <b>{{items|arrayLength}}</b>
      </td></tr>
      <tr><td>
          number of matching results: 
      </td><td>
          <b>{{items|matchCount:searchString}}</b>
      </td></tr>
      <tr><td>
          search string: 
      </td><td>
          "<b>{{searchString}}</b>"
      </td></tr>
    <!--
      <tr><td>
          search length: 
      </td><td>
          "<b>{{searchString|strlen}}</b>"
      </td></tr>
      <tr><td>
          search reversed:
      </td><td>
          "<b>{{searchString|reverse}}</b>"
      </td></tr>
    -->
    </table>
    <br>

  </div><!-- container -->

  <div class="popover_box" ng-click="$event.stopPropagation()" ng-show="showtooltip">

    <span ng-show="dynamicDefinition()"><h2><u>Exact Match</u></h2> &mdash; Edit Word <b>{{searchString}}</b></span>
    <span ng-show="!dynamicDefinition()">Add New Word <b>{{searchString}}</b></span>


<!-- ng-model binds the contents of the text field with the "value" model.
 Any changes to the text field will automatically update the value, and
 all other bindings on the page that depend on it.  -->

    <br>
    Word: 
        <input type="text" ng-model="searchString" />
    def: 
        <textarea rows="6" cols="30" type="text" ng-model="definition" ng-focus="stopOverride()" ng-blur="resumeOverride()" ></textarea>

    <br>
    <input type="button" value="Delete" /> &nbsp;
    <input type="button" value="Cancel" /> &nbsp;
    <input type="button" value="Submit" />
  </div>

  <div class="confirm" ng-show="showConfirm">
    CONFIRM DIALOG <br>
    <input type="submit" value="Cancel" /> &nbsp;
    <input type="submit" value="OK" />
  </div>

  <!-- Render a li element for every entry in the items array. Notice
       the custom search filter "searchFor". It takes the value of the
       searchString model as an argument.  -->
  <table class="h" cellpadding="0" cellspacing="0" border="0">
    <tr ng-repeat="i in items | searchFor:searchString">
      <td class="left">{{i.word}}</td>
      <td class="right">{{i.def}}</td>
    </tr>
  </table>

</center>
</div><!-- main-panel -->

</body>
</html>
